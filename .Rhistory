library(haven)
combined_covid_general_2020 <- read_dta("GitHub/long-covid-sick-notes/output/cohorts/combined_covid_general_2020.dta")
View(combined_covid_general_2020)
library(haven)
cohort_rates_covid_2020 <- read_dta("GitHub/long-covid-sick-notes/output/cohorts/cohort_rates_covid_2020.dta")
View(cohort_rates_covid_2020)
library(haven)
combined_covid_2020_pneumonia <- read_dta("GitHub/long-covid-sick-notes/output/cohorts/combined_covid_2020_pneumonia.dta")
View(combined_covid_2020_pneumonia)
View(cohort_rates_covid_2020)
library(haven)
cohort_rates_matched_2020 <- read_dta("GitHub/long-covid-sick-notes/output/cohorts/cohort_rates_matched_2020.dta")
View(cohort_rates_matched_2020)
library(haven)
cohort_rates_matched_2020 <- read_dta("GitHub/long-covid-sick-notes/output/cohorts/cohort_rates_matched_2020.dta")
View(cohort_rates_matched_2020)
library(haven)
combined_covid_general_2020 <- read_dta("GitHub/long-covid-sick-notes/output/cohorts/combined_covid_general_2020.dta")
View(combined_covid_general_2020)
library(haven)
library(tidyverse)
library(reshape2)
library(tools)
library(here)
library(fs)
library(RColorBrewer)
library(lubridate)
setwd("C:/Users/aschaffer/OneDrive - Nexus365/Documents/GitHub/long-covid-sick-notes")
# getwd()
detach("package:here", unload = TRUE)
library(here)
## Create directories if needed
dir_create(here::here("output", "tabfig"), showWarnings = FALSE, recurse = TRUE)
dir_create(here::here("output", "cohorts"), showWarnings = FALSE, recurse = TRUE)
##### Read in data for each cohort #####
read <- function(data){
read_dta(here::here("output","cohorts",data)) %>%
mutate(
sick_note_end_date = as.Date(sick_note_end_date, format = "%Y-%m-%d"),
indexdate = as.Date(indexdate, format = "%Y-%m-%d"),
end_month  = floor_date(as.Date(sick_note_end_date), unit="month"),
index_month =  floor_date(as.Date(indexdate), unit="month")
) %>%
dplyr::select(c(patient_id, end_month, index_month, sick_note))
}
covid20 <- read("cohort_rates_covid_2020.dta")
covid21 <- read("cohort_rates_covid_2021.dta")
covid22 <- read("cohort_rates_covid_2022.dta")
pneumo19 <- read("cohort_rates_pneumonia_2019.dta")
gen19 <- read("cohort_rates_matched_2019.dta")
gen20 <- read("cohort_rates_matched_2020.dta")
gen21 <- read("cohort_rates_matched_2021.dta")
gen22 <- read("cohort_rates_matched_2022.dta")
###### Create distribution of end dates #########
tab <- function(data) {
end <- data %>%
mutate(total = n()) %>%
arrange(end_month, sick_note) %>%
group_by(sick_note, end_month, total) %>%
summarise(n_end = n()) %>%
rename(month = end_month)
index <- data %>%
mutate(total = n()) %>%
arrange(index_month, sick_note) %>%
group_by(sick_note, index_month, total) %>%
summarise(n_index = n()) %>%
rename(month = index_month)
both <- merge(end, index, by = c("month","total","sick_note"))
return(both)
}
####### Save files ##########
covid20_tab <- tab(covid20)
write_csv(covid20_tab, here::here("output", "tabfig", "end_date_covid20.csv"))
covid21_tab <- tab(covid21)
write_csv(covid21_tab, here::here("output", "tabfig", "end_date_covid21.csv"))
covid22_tab <- tab(covid22)
write_csv(covid22_tab, here::here("output", "tabfig", "end_date_covid22.csv"))
pneumo19_tab <- tab(pneumo19)
write_csv(gen21_tab, here::here("output", "tabfig", "end_date_pneumo19.csv"))
View(covid22_tab)
View(covid20)
##### Read in data for each cohort #####
read <- function(data){
read_dta(here::here("output","cohorts",data)) %>%
mutate(
sick_note_end_date = as.Date(sick_note_end_date, format = "%Y-%m-%d"),
indexdate = as.Date(indexdate, format = "%Y-%m-%d"),
end_month  = floor_date(as.Date(sick_note_end_date), unit="month"),
index_month =  floor_date(as.Date(indexdate), unit="month")
)
}
covid20 <- read("cohort_rates_covid_2020.dta")
View(covid20)
View(covid22_tab)
View(covid22_tab)
###### Create distribution of end dates #########
tab <- function(data) {
end <- data %>%
mutate(total = n()) %>%
arrange(end_month, sick_note) %>%
group_by(sick_note, end_month, total) %>%
summarise(n_end = n()) %>%
rename(month = end_month) %>%
mutate(n_end = case_when(n_end > 5 ~ n_end),
n_end = round(n_end / 7) * 7)
index <- data %>%
mutate(total = n()) %>%
arrange(index_month, sick_note) %>%
group_by(sick_note, index_month, total) %>%
summarise(n_index = n()) %>%
rename(month = index_month) %>%
mutate(n_index = case_when(n_index > 5 ~ n_index),
n_index = round(n_index / 7) * 7,)
both <- merge(end, index, by = c("month","total","sick_note"))
return(both)
}
####### Save files ##########
covid20_tab <- tab(covid20)
###### Create distribution of end dates #########
tab <- function(data) {
end <- data %>%
mutate(total = n()) %>%
arrange(end_month, sick_note) %>%
group_by(sick_note, end_month, total) %>%
summarise(n_end = n()) %>%
rename(month = end_month) %>%
mutate(n_end = case_when(n_end > 5 ~ n_end),
n_end = round(n_end / 7) * 7)
index <- data %>%
mutate(total = n()) %>%
arrange(index_month, sick_note) %>%
group_by(sick_note, index_month, total) %>%
summarise(n_index = n()) %>%
rename(month = index_month) %>%
mutate(n_index = case_when(n_index > 5 ~ n_index),
n_index = round(n_index / 7) * 7,)
both <- merge(end, index, by = c("month","total","sick_note"))
return(both)
}
####### Save files ##########
covid20_tab <- tab(covid20)
View(covid20_tab)
## Create directories if needed
dir_create(here::here("output", "tabfig"), showWarnings = FALSE, recurse = TRUE)
##### Read in data for each cohort #####
covid20 <- read_dta(here::here("output", "cohorts", "combined_covid_2020_general_2019.dta")) %>%
subset(case == 1)
covid21 <- read_dta(here::here("output", "cohorts", "combined_covid_2021_general_2019.dta")) %>%
subset(case == 1)
covid22 <- read_dta(here::here("output", "cohorts", "combined_covid_2022_general_2019.dta")) %>%
subset(case == 1)
# Frequencies for each demographic/clinical variable
covid_type <- function(cohort, name) {
cohort1 <- cohort %>%
mutate(total = n(),
sgss = if_else(sick_note_end_date = sgss_positive,
1, 0, 0),
primarycare = if_else(sick_note_end_date = primary_care_covid_date,
1, 0, 0),
hospital = if_else(sick_note_end_date = hospital_covid_date,
1, 0, 0))
# Counts within each variable category
counts <- cohort1 %>%
group_by(total) %>%
summarise(sgss = sum(sgss),
primarycare = sum(primarycare),
hospital = sum(hospital)) %>%
mutate(# Rounding and redaction
total = case_when(total > 5 ~ total),
total = round(total / 7) * 7,
sgss = case_when(sgss > 5 ~ sgss),
sgss = round(sgss / 7) * 7,
primarycare = case_when(primarycare > 5 ~ primarycare),
primarycare = round(primarycare / 7) * 7,
hospital = case_when(hospital > 5 ~ hospital),
hospital = round(hospital / 7) * 7,
pcent_sgss = sgss / total * 100,
pcent_primarycare = primarycare / total * 100,
pcent_hospital = hospital / total * 100,
cohort = name)
return(counts)
}
covid_all <- rbind(covid_type(covid20, "COVID2020"),
covid_type(covid21, "COVID2021"),
covid_type(covid22, "COVID2022"))
# Frequencies for each demographic/clinical variable
covid_type <- function(cohort, name) {
cohort1 <- cohort %>%
mutate(total = n(),
sgss = if_else(sick_note_end_date == sgss_positive,
1, 0, 0),
primarycare = if_else(sick_note_end_date == primary_care_covid_date,
1, 0, 0),
hospital = if_else(sick_note_end_date == hospital_covid_date,
1, 0, 0))
# Counts within each variable category
counts <- cohort1 %>%
group_by(total) %>%
summarise(sgss = sum(sgss),
primarycare = sum(primarycare),
hospital = sum(hospital)) %>%
mutate(# Rounding and redaction
total = case_when(total > 5 ~ total),
total = round(total / 7) * 7,
sgss = case_when(sgss > 5 ~ sgss),
sgss = round(sgss / 7) * 7,
primarycare = case_when(primarycare > 5 ~ primarycare),
primarycare = round(primarycare / 7) * 7,
hospital = case_when(hospital > 5 ~ hospital),
hospital = round(hospital / 7) * 7,
pcent_sgss = sgss / total * 100,
pcent_primarycare = primarycare / total * 100,
pcent_hospital = hospital / total * 100,
cohort = name)
return(counts)
}
covid_all <- rbind(covid_type(covid20, "COVID2020"),
covid_type(covid21, "COVID2021"),
covid_type(covid22, "COVID2022"))
View(covid_all)
View(covid20)
# Frequencies for each demographic/clinical variable
covid_type <- function(cohort, name) {
cohort1 <- cohort %>%
mutate(total = n(),
sgss = if_else(sick_note_end_date == sgss_positive & !is.na(sgss_positive),
1, 0, 0),
primarycare = if_else(sick_note_end_date == primary_care_covid_date & !is.na(primary_care_covid_date),
1, 0, 0),
hospital = if_else(sick_note_end_date == hospital_covid_date & !is.na(hospital_covid_date),
1, 0, 0))
# Counts within each variable category
counts <- cohort1 %>%
group_by(total) %>%
summarise(sgss = sum(sgss),
primarycare = sum(primarycare),
hospital = sum(hospital)) %>%
mutate(# Rounding and redaction
total = case_when(total > 5 ~ total),
total = round(total / 7) * 7,
sgss = case_when(sgss > 5 ~ sgss),
sgss = round(sgss / 7) * 7,
primarycare = case_when(primarycare > 5 ~ primarycare),
primarycare = round(primarycare / 7) * 7,
hospital = case_when(hospital > 5 ~ hospital),
hospital = round(hospital / 7) * 7,
pcent_sgss = sgss / total * 100,
pcent_primarycare = primarycare / total * 100,
pcent_hospital = hospital / total * 100,
cohort = name)
return(counts)
}
covid_all <- rbind(covid_type(covid20, "COVID2020"),
covid_type(covid21, "COVID2021"),
covid_type(covid22, "COVID2022"))
##### Create separate table/csv file for each cohort #####
write.csv(covid_all, here::here("output", "tabfig", "table_covid_type.csv"))
# For running locally only #
# setwd("C:/Users/aschaffer/OneDrive - Nexus365/Documents/GitHub/long-covid-sick-notes")
# getwd()
## Create directories if needed
dir_create(here::here("output", "tabfig"), showWarnings = FALSE, recurse = TRUE)
dir_create(here::here("output", "cohorts"), showWarnings = FALSE, recurse = TRUE)
##### Read in data for each cohort #####
read <- function(data){
read_dta(here::here("output","cohorts",data)) %>%
mutate(
sick_note_end_date = as.Date(sick_note_end_date, format = "%Y-%m-%d"),
indexdate = as.Date(indexdate, format = "%Y-%m-%d"),
end_month  = floor_date(as.Date(sick_note_end_date), unit="month"),
index_month =  floor_date(as.Date(indexdate), unit="month")
) %>%
dplyr::select(c(patient_id, end_month, index_month, sick_note,
sgss_positive, primary_care_covid_date, hospital_covid_date))
}
covid20 <- read("cohort_rates_covid_2020.dta")
covid21 <- read("cohort_rates_covid_2021.dta")
covid22 <- read("cohort_rates_covid_2022.dta")
pneumo19 <- read("cohort_rates_pneumonia_2019.dta")
gen19 <- read("cohort_rates_matched_2019.dta")
gen20 <- read("cohort_rates_matched_2020.dta")
##### Read in data for each cohort #####
read <- function(data){
read_dta(here::here("output","cohorts",data)) %>%
mutate(
sick_note_end_date = as.Date(sick_note_end_date, format = "%Y-%m-%d"),
indexdate = as.Date(indexdate, format = "%Y-%m-%d"),
end_month  = floor_date(as.Date(sick_note_end_date), unit="month"),
index_month =  floor_date(as.Date(indexdate), unit="month")
) %>%
dplyr::select(c(patient_id, end_month, index_month, sick_note))
}
covid20 <- read("cohort_rates_covid_2020.dta")
covid21 <- read("cohort_rates_covid_2021.dta")
covid22 <- read("cohort_rates_covid_2022.dta")
pneumo19 <- read("cohort_rates_pneumonia_2019.dta")
gen19 <- read("cohort_rates_matched_2019.dta")
gen20 <- read("cohort_rates_matched_2020.dta")
gen21 <- read("cohort_rates_matched_2021.dta")
gen22 <- read("cohort_rates_matched_2022.dta")
###### Create distribution of end dates #########
tab <- function(data) {
end <- data %>%
mutate(total = n()) %>%
arrange(end_month, sick_note) %>%
group_by(sick_note, end_month, total) %>%
summarise(n_end = n()) %>%
rename(month = end_month) %>%
mutate(n_end = case_when(n_end > 5 ~ n_end),
n_end = round(n_end / 7) * 7)
index <- data %>%
mutate(total = n()) %>%
arrange(index_month, sick_note) %>%
group_by(sick_note, index_month, total) %>%
summarise(n_index = n()) %>%
rename(month = index_month) %>%
mutate(n_index = case_when(n_index > 5 ~ n_index),
n_index = round(n_index / 7) * 7,)
both <- merge(end, index, by = c("month","total","sick_note"))
return(both)
}
####### Save files ##########
covid20_tab <- tab(covid20)
write_csv(covid20_tab, here::here("output", "tabfig", "dates_covid20.csv"))
covid21_tab <- tab(covid21)
write_csv(covid21_tab, here::here("output", "tabfig", "dates_covid21.csv"))
covid22_tab <- tab(covid22)
write_csv(covid22_tab, here::here("output", "tabfig", "dates_covid22.csv"))
pneumo19_tab <- tab(pneumo19)
write_csv(gen21_tab, here::here("output", "tabfig", "dates_pneumo19.csv"))
gen19_tab <- tab(gen19)
write_csv(gen19_tab, here::here("output", "tabfig", "dates_gen19.csv"))
gen20_tab <- tab(gen20)
write_csv(gen20_tab, here::here("output", "tabfig", "dates_gen20.csv"))
gen21_tab <- tab(gen21)
write_csv(gen21_tab, here::here("output", "tabfig", "dates_gen21.csv"))
gen22_tab <- tab(gen22)
write_csv(gen22_tab, here::here("output", "tabfig", "dates_gen22.csv"))
# Frequencies for COVID diagnosis type
covid_type <- function(cohort, name) {
cohort1 <- cohort %>%
mutate(total = n(),
sgss = if_else(index_date - 1 == sgss_positive & !is.na(sgss_positive),
1, 0, 0),
primarycare = if_else(index_date - 1 == primary_care_covid_date & !is.na(primary_care_covid_date),
1, 0, 0),
hospital = if_else(index_date == hospital_covid_date & !is.na(hospital_covid_date),
1, 0, 0))
# Counts within each variable category
counts <- cohort1 %>%
group_by(total) %>%
summarise(sgss = sum(sgss),
primarycare = sum(primarycare),
hospital = sum(hospital)) %>%
mutate(# Rounding and redaction
total = case_when(total > 5 ~ total),
total = round(total / 7) * 7,
sgss = case_when(sgss > 5 ~ sgss),
sgss = round(sgss / 7) * 7,
primarycare = case_when(primarycare > 5 ~ primarycare),
primarycare = round(primarycare / 7) * 7,
hospital = case_when(hospital > 5 ~ hospital),
hospital = round(hospital / 7) * 7,
pcent_sgss = sgss / total * 100,
pcent_primarycare = primarycare / total * 100,
pcent_hospital = hospital / total * 100,
cohort = name)
return(counts)
}
covid_all <- rbind(covid_type(covid20, "COVID2020"),
covid_type(covid21, "COVID2021"),
covid_type(covid22, "COVID2022"))
##### Read in data for each cohort #####
covid20 <- read_dta(here::here("output", "cohorts", "combined_covid_2020_general_2019.dta")) %>%
subset(case == 1)
covid21 <- read_dta(here::here("output", "cohorts", "combined_covid_2021_general_2019.dta")) %>%
subset(case == 1)
covid22 <- read_dta(here::here("output", "cohorts", "combined_covid_2022_general_2019.dta")) %>%
subset(case == 1)
# Frequencies for COVID diagnosis type
covid_type <- function(cohort, name) {
cohort1 <- cohort %>%
mutate(total = n(),
sgss = if_else(index_date - 1 == sgss_positive & !is.na(sgss_positive),
1, 0, 0),
primarycare = if_else(index_date - 1 == primary_care_covid_date & !is.na(primary_care_covid_date),
1, 0, 0),
hospital = if_else(index_date == hospital_covid_date & !is.na(hospital_covid_date),
1, 0, 0))
# Counts within each variable category
counts <- cohort1 %>%
group_by(total) %>%
summarise(sgss = sum(sgss),
primarycare = sum(primarycare),
hospital = sum(hospital)) %>%
mutate(# Rounding and redaction
total = case_when(total > 5 ~ total),
total = round(total / 7) * 7,
sgss = case_when(sgss > 5 ~ sgss),
sgss = round(sgss / 7) * 7,
primarycare = case_when(primarycare > 5 ~ primarycare),
primarycare = round(primarycare / 7) * 7,
hospital = case_when(hospital > 5 ~ hospital),
hospital = round(hospital / 7) * 7,
pcent_sgss = sgss / total * 100,
pcent_primarycare = primarycare / total * 100,
pcent_hospital = hospital / total * 100,
cohort = name)
return(counts)
}
covid_all <- rbind(covid_type(covid20, "COVID2020"),
covid_type(covid21, "COVID2021"),
covid_type(covid22, "COVID2022"))
View(covid20)
# Frequencies for COVID diagnosis type
covid_type <- function(cohort, name) {
cohort1 <- cohort %>%
mutate(total = n(),
sgss = if_else(indexdate == sgss_positive & !is.na(sgss_positive),
1, 0, 0),
primarycare = if_else(indexdate == primary_care_covid_date & !is.na(primary_care_covid_date),
1, 0, 0),
hospital = if_else(indexdate == hospital_covid_date & !is.na(hospital_covid_date),
1, 0, 0))
# Counts within each variable category
counts <- cohort1 %>%
group_by(total) %>%
summarise(sgss = sum(sgss),
primarycare = sum(primarycare),
hospital = sum(hospital)) %>%
mutate(# Rounding and redaction
total = case_when(total > 5 ~ total),
total = round(total / 7) * 7,
sgss = case_when(sgss > 5 ~ sgss),
sgss = round(sgss / 7) * 7,
primarycare = case_when(primarycare > 5 ~ primarycare),
primarycare = round(primarycare / 7) * 7,
hospital = case_when(hospital > 5 ~ hospital),
hospital = round(hospital / 7) * 7,
pcent_sgss = sgss / total * 100,
pcent_primarycare = primarycare / total * 100,
pcent_hospital = hospital / total * 100,
cohort = name)
return(counts)
}
covid_all <- rbind(covid_type(covid20, "COVID2020"),
covid_type(covid21, "COVID2021"),
covid_type(covid22, "COVID2022"))
##### Create separate table/csv file for each cohort #####
write.csv(covid_all, here::here("output", "tabfig", "table_covid_type.csv"))
