
text = element_text(size = 9))
##### Bar chart to visualise results #####
ggplot(subset(all, (adjustment %in% c("Demographics + clinical"))),
aes(x = month)) +
geom_errorbar(aes(ymax = uc, ymin = lc), width = 0.15, col="gray50") +
geom_point(aes(y = hr, col = month)) +
geom_hline(aes(yintercept = 1),linetype = "longdash", col ="gray60")+
scale_color_manual(values = brewer.pal(4, "Spectral")) +
scale_y_continuous(trans='log2', breaks=c(1,2,4), lim=c(.5,6)) +
#scale_x_discrete(limits = rev) +
facet_wrap(~ comparator, nrow = 3)+
ylab("HR (95%CI)") + xlab(NULL) +
theme_bw()+
theme(legend.title = element_blank(),
legend.position = "none",
panel.grid.major.y = element_line(color = "gray95"),
panel.grid.minor.y = element_blank(),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank(),
strip.background = element_blank(),
strip.text = element_text(hjust= 0),
text = element_text(size = 9))
cov20_gen20 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/cox_model_split_summary_general_2020.csv", delim = ";")
cov20_gen19 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/cox_model_split_summary_2020_general_2019.csv", delim = ";")
cov21_gen21 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/cox_model_split_summary_general_2021.csv", delim = ";")
cov21_gen19 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/cox_model_split_summary_2021_general_2019.csv", delim = ";")
cov20_pneumo19 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/cox_model_split_summary_2020_pneumonia.csv", delim = ";")
cov21_pneumo19 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/cox_model_split_summary_2021_pneumonia.csv", delim = ";")
all <- rbind(cov20_gen20, cov20_gen19, cov21_gen21, cov21_gen19, cov20_pneumo19, cov21_pneumo19)
all$comparator <- factor(all$comparator, levels = c("2020_general_2019", "general_2020", "2021_general_2019", "general_2021",
"2020_pneumonia", "2021_pneumonia"),
labels = c("COVID 2020 vs general pop 2020",
"COVID 2020 vs general pop 2019",
"COVID 2020 vs pneumonia 2019 (hospitalised)",
"COVID 2021 vs general pop 2021",
"COVID 2021 vs general pop 2019",
"COVID 2021 vs pneumonia 2019 (hospitalised)"))
all$adjustment <- factor(all$adjustment, levels = c("crude","age_sex","demo_eth","demo_eth_clinical",
"demo_noeth","demo_noeth_clinical"),
labels=c("Crude","Age/sex","Demographics","Demographics + clinical",
"Demographics (no ethnicity)",
"Demographics + clinical (no ethnicity)"))
all$month <- factor(all$month, levels=c(0,30,90,150), labels = c("<30 days","30-90 days","90-150 days",">150 days"))
##### Bar chart to visualise results #####
ggplot(subset(all, (adjustment %in% c("Demographics + clinical"))),
aes(x = month)) +
geom_errorbar(aes(ymax = uc, ymin = lc), width = 0.15, col="gray50") +
geom_point(aes(y = hr, col = month)) +
geom_hline(aes(yintercept = 1),linetype = "longdash", col ="gray60")+
scale_color_manual(values = brewer.pal(4, "Spectral")) +
scale_y_continuous(trans='log2', breaks=c(1,2,4), lim=c(.5,6)) +
#scale_x_discrete(limits = rev) +
facet_wrap(~ comparator, nrow = 3)+
ylab("HR (95%CI)") + xlab(NULL) +
theme_bw()+
theme(legend.title = element_blank(),
legend.position = "none",
panel.grid.major.y = element_line(color = "gray95"),
panel.grid.minor.y = element_blank(),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank(),
strip.background = element_blank(),
strip.text = element_text(hjust= 0),
text = element_text(size = 9))
ggplot(subset(all, (adjustment %in% c("Demographics + clinical"))),
aes(x = month)) +
geom_errorbar(aes(ymax = uc, ymin = lc), width = 0.15, col="gray50") +
geom_point(aes(y = hr, col = month)) +
geom_hline(aes(yintercept = 1),linetype = "longdash", col ="gray60")+
scale_color_manual(values = brewer.pal(4, "Spectral")) +
scale_y_continuous(trans='log2', breaks=c(1,2,4), lim=c(.5,6)) +
#scale_x_discrete(limits = rev) +
facet_wrap(~ comparator, nrow = 3)+
ylab("HR (95%CI)") + xlab(NULL) +
theme_bw()+
theme(legend.title = element_blank(),
legend.position = "none",
panel.grid.major.y = element_line(color = "gray95"),
panel.grid.minor.y = element_blank(),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank(),
axis.text.x = element_text(angle= 45),
strip.background = element_blank(),
strip.text = element_text(hjust= 0),
text = element_text(size = 9))
ggplot(subset(all, (adjustment %in% c("Demographics + clinical"))),
aes(x = month)) +
geom_errorbar(aes(ymax = uc, ymin = lc), width = 0.15, col="gray50") +
geom_point(aes(y = hr, col = month)) +
geom_hline(aes(yintercept = 1),linetype = "longdash", col ="gray60")+
scale_color_manual(values = brewer.pal(4, "Spectral")) +
scale_y_continuous(trans='log2', breaks=c(1,2,4), lim=c(.5,6)) +
#scale_x_discrete(limits = rev) +
facet_wrap(~ comparator, nrow = 3)+
ylab("HR (95%CI)") + xlab(NULL) +
theme_bw()+
theme(legend.title = element_blank(),
legend.position = "none",
panel.grid.major.y = element_line(color = "gray95"),
panel.grid.minor.y = element_blank(),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank(),
axis.text.x = element_text(angle= 45,hjust=1),
strip.background = element_blank(),
strip.text = element_text(hjust= 0),
text = element_text(size = 9))
all <- rbind(cov20_gen20, cov20_gen19, cov21_gen21, cov21_gen19, cov20_pneumo19, cov21_pneumo19)
all$comparator <- factor(all$comparator, levels = c("2020_general_2019", "general_2020", "2021_general_2019", "general_2021",
"2020_pneumonia", "2021_pneumonia"),
labels = c("COVID 2020 vs\ngeneral pop 2020",
"COVID 2020 vs\ngeneral pop 2019",
"COVID 2020 vs\npneumonia 2019 (hospitalised)",
"COVID 2021 vs\ngeneral pop 2021",
"COVID 2021 vs\ngeneral pop 2019",
"COVID 2021 vs\npneumonia 2019 (hospitalised)"))
all$adjustment <- factor(all$adjustment, levels = c("crude","age_sex","demo_eth","demo_eth_clinical",
"demo_noeth","demo_noeth_clinical"),
labels=c("Crude","Age/sex","Demographics","Demographics + clinical",
"Demographics (no ethnicity)",
"Demographics + clinical (no ethnicity)"))
all$month <- factor(all$month, levels=c(0,30,90,150), labels = c("<30 days","30-90 days","90-150 days",">150 days"))
##### Bar chart to visualise results #####
ggplot(subset(all, (adjustment %in% c("Demographics + clinical"))),
aes(x = month)) +
geom_errorbar(aes(ymax = uc, ymin = lc), width = 0.15, col="gray50") +
geom_point(aes(y = hr, col = month)) +
geom_hline(aes(yintercept = 1),linetype = "longdash", col ="gray60")+
scale_color_manual(values = brewer.pal(4, "Spectral")) +
scale_y_continuous(trans='log2', breaks=c(1,2,4), lim=c(.5,6)) +
#scale_x_discrete(limits = rev) +
facet_wrap(~ comparator, nrow = 3)+
ylab("HR (95%CI)") + xlab(NULL) +
theme_bw()+
theme(legend.title = element_blank(),
legend.position = "none",
panel.grid.major.y = element_line(color = "gray95"),
panel.grid.minor.y = element_blank(),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank(),
axis.text.x = element_text(angle= 45,hjust=1),
strip.background = element_blank(),
strip.text = element_text(hjust= 0),
text = element_text(size = 9))
##### Bar chart to visualise results #####
ggplot(subset(all, (adjustment %in% c("Demographics + clinical"))),
aes(x = month)) +
geom_errorbar(aes(ymax = uc, ymin = lc), width = 0.15, col="gray50") +
geom_point(aes(y = hr, col = month)) +
geom_hline(aes(yintercept = 1),linetype = "longdash", col ="gray60")+
scale_color_manual(values = brewer.pal(4, "Spectral")) +
scale_y_continuous(trans='log2', breaks=c(1,2,4), lim=c(.5,6)) +
#scale_x_discrete(limits = rev) +
facet_wrap(~ comparator, nrow = 2)+
ylab("HR (95%CI)") + xlab(NULL) +
theme_bw()+
theme(legend.title = element_blank(),
legend.position = "none",
panel.grid.major.y = element_line(color = "gray95"),
panel.grid.minor.y = element_blank(),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank(),
axis.text.x = element_text(angle= 45,hjust=1),
strip.background = element_blank(),
strip.text = element_text(hjust= 0),
text = element_text(size = 9))
all <- rbind(cov20_gen20, cov20_gen19, cov21_gen21, cov21_gen19, cov20_pneumo19, cov21_pneumo19)
all$comparator <- factor(all$comparator, levels = c("general_2020", "2020_general_2019", "2020_pneumonia","2021_general_2019", "general_2021",
"2021_pneumonia"),
labels = c("COVID 2020 vs\ngeneral pop 2020",
"COVID 2020 vs\ngeneral pop 2019",
"COVID 2020 vs\npneumonia 2019 (hospitalised)",
"COVID 2021 vs\ngeneral pop 2021",
"COVID 2021 vs\ngeneral pop 2019",
"COVID 2021 vs\npneumonia 2019 (hospitalised)"))
all$adjustment <- factor(all$adjustment, levels = c("crude","age_sex","demo_eth","demo_eth_clinical",
"demo_noeth","demo_noeth_clinical"),
labels=c("Crude","Age/sex","Demographics","Demographics + clinical",
"Demographics (no ethnicity)",
"Demographics + clinical (no ethnicity)"))
all$month <- factor(all$month, levels=c(0,30,90,150), labels = c("<30 days","30-90 days","90-150 days",">150 days"))
##### Bar chart to visualise results #####
ggplot(subset(all, (adjustment %in% c("Demographics + clinical"))),
aes(x = month)) +
geom_errorbar(aes(ymax = uc, ymin = lc), width = 0.15, col="gray50") +
geom_point(aes(y = hr, col = month)) +
geom_hline(aes(yintercept = 1),linetype = "longdash", col ="gray60")+
scale_color_manual(values = brewer.pal(4, "Spectral")) +
scale_y_continuous(trans='log2', breaks=c(1,2,4), lim=c(.5,6)) +
#scale_x_discrete(limits = rev) +
facet_wrap(~ comparator, nrow = 2)+
ylab("HR (95%CI)") + xlab(NULL) +
theme_bw()+
theme(legend.title = element_blank(),
legend.position = "none",
panel.grid.major.y = element_line(color = "gray95"),
panel.grid.minor.y = element_blank(),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank(),
axis.text.x = element_text(angle= 45,hjust=1),
strip.background = element_blank(),
strip.text = element_text(hjust= 0),
text = element_text(size = 9))
ggplot(subset(all, (adjustment %in% c("Demographics + clinical"))),
aes(x = month)) +
geom_errorbar(aes(ymax = uc, ymin = lc), width = 0.2, col="gray50") +
geom_point(aes(y = hr, col = month)) +
geom_hline(aes(yintercept = 1),linetype = "longdash", col ="gray60")+
scale_color_manual(values = brewer.pal(4, "Spectral")) +
scale_y_continuous(trans='log2', breaks=c(1,2,4), lim=c(.5,6)) +
#scale_x_discrete(limits = rev) +
facet_wrap(~ comparator, nrow = 2)+
ylab("HR (95%CI)") + xlab(NULL) +
theme_bw()+
theme(legend.title = element_blank(),
legend.position = "none",
panel.grid.major.y = element_line(color = "gray95"),
panel.grid.minor.y = element_blank(),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank(),
axis.text.x = element_text(angle= 45,hjust=1),
strip.background = element_blank(),
strip.text = element_text(hjust= 0),
text = element_text(size = 9))
View(all)
diag <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/diag_by_cohort.csv")
View(diag)
cov20_gen20 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_covid_2020.csv", delim = ";")
View(cov20_gen20)
cov20 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_covid_2020.csv", delim = ";")
cov21 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_covid_2021.csv", delim = ";")
covhosp20 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_covid_hosp_2020.csv", delim = ";")
covhosp21 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_covid_hosp_2021.csv", delim = ";")
gen19 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_gen_2019.csv", delim = ";")
gen20 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_gen_2020.csv", delim = ";")
gen21 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_gen_2021.csv", delim = ";")
pneumo19 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_pneumo_2019.csv", delim = ";")
View(cov21)
View(diag)
View(diag)
View(diag)
cov20 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_covid_2020.csv", delim = ";") %>%
mutate(group = "COVID-19 2020")
cov21 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_covid_2021.csv", delim = ";") %>%
mutate(group = "COVID-19 2021")
covhosp20 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_covid_hosp_2020.csv", delim = ";") %>%
mutate(group = "COVID-19 hospitalised 2020")
covhosp21 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_covid_hosp_2021.csv", delim = ";") %>%
mutate(group = "COVID-19 hospitalised 2021")
gen19 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_gen_2019.csv", delim = ";") %>%
mutate(group = "General population 2019")
gen20 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_gen_2020.csv", delim = ";")%>%
mutate(group = "General population 2020")
gen21 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_gen_2021.csv", delim = ";") %>%
mutate(group = "General population 2021")
pneumo19 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_pneumo_2019.csv", delim = ";") %>%
mutate(group = "Pneumonia 2019")
all <- rbind(cov20,cov21,covhosp20,covhosp21,gen19,gen20,gen21,pneumo19)
all <- rbind(cov20,cov21,covhosp20,covhosp21,gen19,gen20,gen21,pneumo19)
tot_sick_note <- all %>%
subset(category %in% c("Male","Female")) %>%
group_by(group) %>%
summarise(n_sicknote = sum(n))
View(tot_sick_note)
View(diag)
tot_sick_note <- all %>%
subset(category %in% c("Male","Female")) %>%
group_by(group) %>%
summarise(n_sicknote = sum(n_sick_note))
tot_sick_note <- all %>%
subset(category %in% c("Male","Female")) %>%
group_by(group) %>%
summarise(n_sicknote = sum(n_sick_note))
all <- rbind(cov20,cov21,covhosp20,covhosp21,gen19,gen20,gen21,pneumo19)
tot_sick_note <- all %>%
subset(category %in% c("Male","Female")) %>%
group_by(group) %>%
summarise(n_sicknote = sum(n_sick_note))
View(all)
class(all$n_sick_note)
all <- rbind(cov20,cov21,covhosp20,covhosp21,gen19,gen20,gen21,pneumo19) %>%
mutate(n_sick_note = as.numeric(n_sick_note))
tot_sick_note <- all %>%
subset(category %in% c("Male","Female")) %>%
group_by(group) %>%
summarise(n_sicknote = sum(n_sick_note))
View(tot_sick_note)
diag2 <- merge(diag, diag2, by="group")
diag2 <- merge(diag, tot_sick_note, by="group")
View(tot_sick_note)
View(diag)
diag <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/diag_by_cohort.csv")
cov20 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_covid_2020.csv", delim = ";") %>%
mutate(cohort = "COVID-19 2020")
cov21 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_covid_2021.csv", delim = ";") %>%
mutate(cohort = "COVID-19 2021")
covhosp20 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_covid_hosp_2020.csv", delim = ";") %>%
mutate(cohort = "COVID-19 hospitalised 2020")
covhosp21 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_covid_hosp_2021.csv", delim = ";") %>%
mutate(cohort = "COVID-19 hospitalised 2021")
gen19 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_gen_2019.csv", delim = ";") %>%
mutate(cohort = "General population 2019")
gen20 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_gen_2020.csv", delim = ";")%>%
mutate(cohort = "General population 2020")
gen21 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_gen_2021.csv", delim = ";") %>%
mutate(cohort = "General population 2021")
pneumo19 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/table1_pneumo_2019.csv", delim = ";") %>%
mutate(cohort = "Pneumonia 2019")
all <- rbind(cov20,cov21,covhosp20,covhosp21,gen19,gen20,gen21,pneumo19) %>%
mutate(n_sick_note = as.numeric(n_sick_note))
tot_sick_note <- all %>%
subset(category %in% c("Male","Female")) %>%
group_by(cohort) %>%
summarise(n_sicknote = sum(n_sick_note))
diag2 <- merge(diag, tot_sick_note, by="cohort")
View(diag2)
diag2 <- merge(diag, tot_sick_note, by="cohort") %>%
subset(count != "[REDACTED]") %>%
mutate(count = as.numeric(count),
pcent_sick_note = count/n_sick_note * 100)
diag2 <- merge(diag, tot_sick_note, by="cohort") %>%
subset(count != "[REDACTED]") %>%
mutate(count = as.numeric(count),
pcent_sick_note = count/n_sicknote * 100)

##### Read in data for each cohort #####
covid20 <- read_dta(here::here("output", "cohorts", "cohort_rates_covid_2020.dta"))
covidhosp20 <- read_dta(here::here("output", "cohorts", "cohort_rates_covid_2020.dta")) %>%
subset(!is.na(hosp_expo_date))
covid21 <- read_dta(here::here("output", "cohorts", "cohort_rates_covid_2021.dta"))
covidhosp21 <- read_dta(here::here("output", "cohorts", "cohort_rates_covid_2021.dta")) %>%
subset(!is.na(hosp_expo_date))
pneumo19 <- read_dta(here::here("output", "cohorts", "cohort_rates_pneumonia_2019.dta"))
gen19 <- read_dta(here::here("output", "cohorts", "cohort_rates_matched_2019.dta"))
gen20 <- read_dta(here::here("output", "cohorts", "cohort_rates_matched_2020.dta"))
gen21 <- read_dta(here::here("output", "cohorts", "cohort_rates_matched_2021.dta"))
View(covid20)
diag <- function(cohort, name){
cohort %>% dplyr::select(c("patient_id", starts_with("diag_"))) %>%
subset(sick_note ==1) %>%
# Calculate total population for denominator
mutate(total = n()) %>%
# Count number of diagnosis categories per person - to identify people with no diagnoses
group_by(patient_id) %>%
mutate(num_diag = sum(!is.na(across(starts_with("diag_")))),
diag_none = ifelse(num_diag == 0, 1, NA)) %>%
ungroup() %>%
# Count total number or people with a non-missing value for each diagnosis category
group_by(total) %>%
summarise(across(starts_with("diag_"), ~ sum(!is.na(.x)))) %>%
# Transpose to long
melt(id = c("total"), value.name = "count", variable.name = "diagnosis") %>%
mutate(# Rounding
count = case_when(count > 5 ~ count),
count = round(count / 7) * 7,
total = case_when(total > 5 ~ total),
total = round(total / 7) * 7,
# Calculate percent of population + 95%CI with each category
# (NB: Given the large sample size, these may be too narrow to be
# useful)
pcent =  count / total * 100,
lci = pcent - (1.96 * sqrt((pcent * (100 - pcent)) / total)),
uci = pcent + (1.96 * sqrt((pcent * (100 - pcent)) / total)),
# Variable for cohort
cohort = name,
# Convert to more readable diagnosis category name
diagnosis =
toTitleCase(str_replace_all(diagnosis, c("diag_" = "", "_" = " "))))
}
###### Apply function to each cohort and combine into one ######
covid2020 <- diag(covid20, "COVID-19 2020")
View(covid20)
###### Function to calculate number of people with each diagnosis #####
diag <- function(cohort, name){
cohort %>% dplyr::select(c("patient_id", starts_with("diag_"), "sick_note")) %>%
subset(sick_note ==1) %>%
# Calculate total population for denominator
mutate(total = n()) %>%
# Count number of diagnosis categories per person - to identify people with no diagnoses
group_by(patient_id) %>%
mutate(num_diag = sum(!is.na(across(starts_with("diag_")))),
diag_none = ifelse(num_diag == 0, 1, NA)) %>%
ungroup() %>%
# Count total number or people with a non-missing value for each diagnosis category
group_by(total) %>%
summarise(across(starts_with("diag_"), ~ sum(!is.na(.x)))) %>%
# Transpose to long
melt(id = c("total"), value.name = "count", variable.name = "diagnosis") %>%
mutate(# Rounding
count = case_when(count > 5 ~ count),
count = round(count / 7) * 7,
total = case_when(total > 5 ~ total),
total = round(total / 7) * 7,
# Calculate percent of population + 95%CI with each category
# (NB: Given the large sample size, these may be too narrow to be
# useful)
pcent =  count / total * 100,
lci = pcent - (1.96 * sqrt((pcent * (100 - pcent)) / total)),
uci = pcent + (1.96 * sqrt((pcent * (100 - pcent)) / total)),
# Variable for cohort
cohort = name,
# Convert to more readable diagnosis category name
diagnosis =
toTitleCase(str_replace_all(diagnosis, c("diag_" = "", "_" = " "))))
}
###### Apply function to each cohort and combine into one ######
covid2020 <- diag(covid20, "COVID-19 2020")
covid2021 <- diag(covid21, "COVID-19 2021")
covidhosp2020 <- diag(covidhosp20, "COVID-19 hospitalised 2020")
covidhosp2021 <- diag(covidhosp21, "COVID-19 hospitalised 2021")
pneumo2019 <- diag(pneumo19, "Pneumonia 2019")
gen2019 <- diag(gen20, "General population 2019")
gen2020 <- diag(gen20, "General population 2020")
gen2021 <- diag(gen20, "General population 2021")
all_diag <- rbind(covid2020, covid2021, covidhosp2020, covidhosp2021,
pneumo2019, gen2019, gen2020, gen2021)
# Save
write.csv(all_diag, here::here("output", "tabfig", "diag_by_cohort.csv"),
row.names = FALSE)
##### Bar chart to visualise results #####
ggplot(subset(all_diag, diagnosis !="None"), aes(x = cohort)) +
geom_bar(aes(y = pcent, fill = cohort),
stat = "identity") +
geom_errorbar(aes(ymin = lci, ymax = uci), width = 0.2, col = "gray50") +
scale_fill_manual(values = brewer.pal(8, "Spectral")) +
ylab("Percentage (%)") + xlab(NULL) +
facet_wrap(~ diagnosis, scales = "free_y", ncol = 4) +
theme(axis.text.x = element_blank(),
axis.ticks.x = element_blank(),
legend.title = element_blank(),
panel.background = element_rect(fill = "gray95"),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank(),
strip.background = element_blank(),
text = element_text(size = 9))
ggsave(here::here("output", "tabfig", "diag_all.png"), dpi = 300,
height = 8, width = 8)
View(all_diag)
View(all_diag)
View(all_diag)
View(diag2)
cox <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/cox_model_summary.csv", delim = ";")
cox$comparator <- factor(cox$comparator, levels = c("2020_general_2019", "general_2020", "2021_general_2019", "general_2021",
"2020_pneumonia", "2021_pneumonia"),
labels = c("COVID 2020 vs\ngeneral pop 2019",
"COVID 2020 vs\ngeneral pop 2020",
"COVID 2021 vs\ngeneral pop 2019",
"COVID 2021 vs\ngeneral pop 2021",
"COVID 2020 vs\npneumonia 2019 (hospitalised)",
"COVID 2021 vs\npneumonia 2019 (hospitalised)"))
cox$adjustment <- factor(cox$adjustment, levels = c("crude","age_sex","demo_eth","demo_eth_clinical",
"demo_noeth","demo_noeth_clinical"),
labels=c("Crude","Age/sex","Demographics","Demographics + clinical",
"Demographics (no ethnicity)",
"Demographics + clinical (no ethnicity)"))
##### Bar chart to visualise results #####
ggplot(subset(cox, (adjustment %in% c("Crude","Age/sex",
"Demographics",
"Demographics + clinical"))
& !(comparator %in% c("COVID 2020 vs\npneumonia 2019 (hospitalised)",
"COVID 2021 vs\npneumonia 2019 (hospitalised)"))),
aes(x = adjustment)) +
geom_point(aes(y = hr, col = adjustment)) +
geom_errorbar(aes(ymax = uc, ymin = lc), width = 0.15, col="gray50") +
geom_hline(aes(yintercept = 1),linetype = "longdash", col ="gray60")+
scale_color_manual(values = brewer.pal(4, "Spectral")) +
scale_y_continuous(trans='log2', breaks=c(1,2,4), lim=c(1,4)) +
scale_x_discrete(limits = rev) +
coord_flip()+
facet_grid(~ comparator)+
ylab("HR (95%CI)") + xlab(NULL) +
theme(legend.title = element_blank(),
panel.background = element_rect(fill = "gray95"),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank(),
strip.background = element_blank(),
text = element_text(size = 9))
ggsave(here::here("output", "tabfig", "diag_all.png"), dpi = 300,
height = 8, width = 8)
##############
cov20_gen20 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/cox_model_split_summary_general_2020.csv", delim = ";")
cov20_gen19 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/cox_model_split_summary_2020_general_2019.csv", delim = ";")
cov21_gen21 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/cox_model_split_summary_general_2021.csv", delim = ";")
cov21_gen19 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/cox_model_split_summary_2021_general_2019.csv", delim = ";")
cov20_pneumo19 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/cox_model_split_summary_2020_pneumonia.csv", delim = ";")
cov21_pneumo19 <- read_delim("C:/Users/aschaffer/OneDrive - Nexus365/Documents/Released outputs/long-covid-sick-notes/output/release30JAN2023/cox_model_split_summary_2021_pneumonia.csv", delim = ";")
all <- rbind(cov20_gen20, cov20_gen19, cov21_gen21, cov21_gen19, cov20_pneumo19, cov21_pneumo19)
all$comparator <- factor(all$comparator, levels = c("general_2020", "2020_general_2019", "2020_pneumonia","2021_general_2019", "general_2021",
"2021_pneumonia"),
labels = c("COVID 2020 vs\ngeneral pop 2020",
"COVID 2020 vs\ngeneral pop 2019",
"COVID 2020 vs\npneumonia 2019 (hospitalised)",
"COVID 2021 vs\ngeneral pop 2021",
"COVID 2021 vs\ngeneral pop 2019",
"COVID 2021 vs\npneumonia 2019 (hospitalised)"))
all$adjustment <- factor(all$adjustment, levels = c("crude","age_sex","demo_eth","demo_eth_clinical",
"demo_noeth","demo_noeth_clinical"),
labels=c("Crude","Age/sex","Demographics","Demographics + clinical",
"Demographics (no ethnicity)",
"Demographics + clinical (no ethnicity)"))
all$month <- factor(all$month, levels=c(0,30,90,150), labels = c("<30 days","30-90 days","90-150 days",">150 days"))
View(all)

